# Buildings & Wonders Review

## Building Effects
- When a city adds or removes a building the delta flows through `CvCityBuildings::SetNumRealBuilding` / `SetNumFreeBuilding`, which in turn calls `CvCity::processBuilding` so every local modifier (yields, happiness, garrison/defense, religion pressure, resources dropped on plots, Great Work slots, trade-route toggles, etc.) is recomputed from one place before the game updates city visuals and UI state. [CvBuildingClasses.cpp](CvBuildingClasses.cpp#L5830-L6115) registers the hook; [CvCity.cpp](CvCity.cpp#L13460-L14450) contains the expansion-specific math for unit experience, instant free units/resources, world-wonder bonuses (tourism, policy freebies, Great Person boosts) and per-unit/policy modifiers, and the later part of the same function keeps resources, trade-route distances, tourism bonuses, religious pressure, and even tile-claiming flags aligned with the new building.
- Empire-wide effects such as policy grants, free great people/techs, global yield modifiers, spy bonuses, trade-route jewelry, he-of-the-wonders flags and wonder-sensitive yields are handled in `CvPlayer::processBuilding`, so a wonder flip can immediately renew global production adjustments and ideology-dependent modifiers without touching every city. [CvPlayer.cpp](CvPlayer.cpp#L15550-L16250)

## Wonder Construction Rules
- `CvPlayer::canConstruct` gates the full building list through civ-specific mapping, cost (–1 disables), tech requirements, policy branches/tenets, resource ownership, victory restrictions, start era caps, building-class limits and per-player/team/global counts before the city even evaluates a queue entry. That same function also uses `getBuildingClassPrereqBuilding` to enforce "X buildings of class Y" prerequisites (with special handling for wonder classes, the world-info multiplier, and One-City-Challenge/No-Annex traits). [CvPlayer.cpp](CvPlayer.cpp#L14090-L14980); [CvPlayer.cpp](CvPlayer.cpp#L15360-L15590)
- Cities check for per-city wonder caps (`isWorldWondersMaxed`, `isTeamWondersMaxed`, `isNationalWondersMaxed`) before a wonder can ever enter the queue; these caps respect the One-City-Challenge override and feed back into `canConstruct` via each building class’s `isNoLimit` flag. [CvCity.cpp](CvCity.cpp#L8460-L8575); when construction is evaluated, limits are enforced before locked/mutually-exclusive logic runs, so a wonder cannot start if the global/per-team/per-player thresholds reached their GD_INT-defined maxima. [CvCity.cpp](CvCity.cpp#L9014-L9065)

## Maintenance
- Every building’s gold upkeep is aggregated in `CvCityBuildings::GetTotalBaseBuildingMaintenance` (buildings + any projects that carry maintenance) and then pushed into the treasury when `CvCityBuildings` records a real-building delta. [CvBuildingClasses.cpp](CvBuildingClasses.cpp#L5610-L5670)
- Extra maintenance (late-game penalties for shortages or overrides) is stored on the city via `SetExtraBuildingMaintenance` and exposed with `GetExtraBuildingMaintenance`, so the UI can display the current gold drain even when it descends outside the per-building loop; resource shortages call this setter once per turn. [CvCity.cpp](CvCity.cpp#L2520-L2580); [CvCity.cpp](CvCity.cpp#L9430-L9510)

## Prerequisites & Limits
- `canConstruct` covers every prerequisite described in the XML: techs (`PrereqAndTech`, `PrereqAndTechs`), policy branches or tenets, resource quantities, unit level/population prerequisites, owned or global follower thresholds, victory conditions, and `isBuildingMaxedOut` checks. The function also emits the same tooltip text the UI reuses when a building is greyed-out, so you can trace why a wonder is illegal by following its early return path. [CvPlayer.cpp](CvPlayer.cpp#L14090-L14980)
- `getBuildingClassPrereqBuilding` accounts for buildings where the XML requires a certain number of a different class, honors the global building-class prereq modifier from the world info, scales with the current count of that class (and the extra value supplied when you continue an existing build), and clamps to one for the One-City-Challenge/No-Annex trait so wonders remain possible in unconquered cities. [CvPlayer.cpp](CvPlayer.cpp#L15360-L15590)
